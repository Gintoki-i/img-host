name: Daily purge all images (CST)

on:
  schedule:
    - cron: "0 23 * * *"   # UTC 23:00 = 北京时间(UTC+8) 次日 07:00
  workflow_dispatch:

permissions:
  contents: write

jobs:
  clean:
    runs-on: ubuntu-latest
    env:
      IMAGEDIR: img           # 根目录（会递归扫描）
      TZ: Asia/Shanghai       # 北京时间
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Delete all images recursively
        shell: bash
        run: |
          set -euo pipefail
          dir="$IMAGEDIR"
          mkdir -p "$dir"
          echo "Scan root: $dir"

          # 常见图片扩展名（大小写不敏感），按需增减
          exts='jpg|jpeg|png|webp|gif|bmp|tiff|tif|svg'

          matched=0
          deleted=0

          # 递归查找并删除
          while IFS= read -r -d '' f; do
            matched=$((matched+1))
            echo "Deleting: $f"
            rm -f -- "$f"
            deleted=$((deleted+1))
          done < <(find "$dir" -type f -iregex ".*\.(${exts})$" -print0)

          echo "Matched images: $matched"
          echo "Deleted images: $deleted"

      - name: Commit & push if changes
        shell: bash
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "chore: purge all images under ${IMAGEDIR}"
            git push
          else
            echo "No changes to commit."
          fi
